import { useCallback, useEffect } from 'react';
import { Bug, Download, Server, Clock } from 'lucide-react';
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  BarChart,
  Bar,
  Cell,
} from 'recharts';
import { useAnalytics } from './AnalyticsLayout';
import { KPIGrid, KPICard, ExportToolbar, exportToCSV, exportToPNG } from '../../components/analytics';
import DataTable from '../../components/DataTable';
import LoadingSpinner from '../../components/LoadingSpinner';
import { useApiWithRefresh } from '../../hooks/useApi';
import api from '../../services/api';

const PORT_COLORS: Record<number, string> = {
  445: '#39ff14',  // SMB
  21: '#00d4ff',   // FTP
  80: '#ff6600',   // HTTP
  443: '#bf00ff',  // HTTPS
  3306: '#ff3366', // MySQL
  1433: '#ffcc00', // MSSQL
};

export default function Malware() {
  const { timeRange, setLastUpdated } = useAnalytics();

  const { data: summary, loading: summaryLoading } = useApiWithRefresh(
    useCallback(() => api.getAnalyticsMalwareSummary(timeRange),
    [timeRange]),
    [timeRange],
    60000
  );

  const { data: timeline, loading: timelineLoading } = useApiWithRefresh(
    useCallback(() => api.getAnalyticsMalwareTimeline(timeRange),
    [timeRange]),
    [timeRange],
    60000
  );

  useEffect(() => {
    if (summary) setLastUpdated(new Date());
  }, [summary, setLastUpdated]);

  const formatTime = (ts: string) => {
    try {
      return new Date(ts).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    } catch {
      return ts;
    }
  };

  const portColumns = [
    { key: 'rank', header: '#', render: (_: any, i: number) => i + 1 },
    { key: 'port', header: 'Port', render: (item: any) => (
      <span className="font-mono text-neon-blue">{item.port}</span>
    )},
    { key: 'service', header: 'Service', render: (item: any) => (
      <span className="text-neon-green">{item.service}</span>
    )},
    { key: 'count', header: 'Events', render: (item: any) => item.count.toLocaleString() },
  ];

  return (
    <div className="space-y-6">
      {/* KPIs */}
      <KPIGrid columns={4}>
        <KPICard
          title="Total Events"
          value={summary?.total_events || 0}
          icon={<Bug className="w-5 h-5" />}
          color="green"
          loading={summaryLoading}
        />
        <KPICard
          title="Unique Attackers"
          value={summary?.unique_attackers || 0}
          icon={<Server className="w-5 h-5" />}
          color="blue"
          loading={summaryLoading}
        />
        <KPICard
          title="File Downloads"
          value={summary?.file_downloads || 0}
          icon={<Download className="w-5 h-5" />}
          color="orange"
          loading={summaryLoading}
        />
        <KPICard
          title="Targeted Ports"
          value={summary?.top_ports?.length || 0}
          icon={<Server className="w-5 h-5" />}
          color="red"
          loading={summaryLoading}
        />
      </KPIGrid>

      {/* Charts */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Timeline */}
        <div className="bg-bg-card rounded-xl border border-bg-hover p-4">
          <div className="flex items-center justify-between mb-4">
            <h3 className="font-display font-bold text-white flex items-center gap-2">
              <Clock className="w-5 h-5 text-neon-green" />
              Event Timeline
            </h3>
            <ExportToolbar
              onExportPNG={() => exportToPNG('malware-timeline', 'malware_timeline')}
            />
          </div>
          <div id="malware-timeline" className="h-64">
            {timelineLoading ? (
              <div className="h-full flex items-center justify-center">
                <LoadingSpinner />
              </div>
            ) : (
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={timeline?.timeline || []}>
                  <defs>
                    <linearGradient id="malwareGradient" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="0%" stopColor="#ff3366" stopOpacity={0.4} />
                      <stop offset="100%" stopColor="#ff3366" stopOpacity={0} />
                    </linearGradient>
                  </defs>
                  <XAxis
                    dataKey="timestamp"
                    tickFormatter={formatTime}
                    stroke="#555"
                    tick={{ fill: '#888', fontSize: 11 }}
                    axisLine={false}
                  />
                  <YAxis stroke="#555" tick={{ fill: '#888', fontSize: 11 }} axisLine={false} />
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'rgba(26, 26, 37, 0.95)',
                      border: '1px solid rgba(255,255,255,0.1)',
                      borderRadius: '8px',
                    }}
                    labelFormatter={formatTime}
                  />
                  <Area
                    type="monotone"
                    dataKey="count"
                    stroke="#ff3366"
                    fill="url(#malwareGradient)"
                    strokeWidth={2}
                  />
                </AreaChart>
              </ResponsiveContainer>
            )}
          </div>
        </div>

        {/* Top Ports */}
        <div className="bg-bg-card rounded-xl border border-bg-hover p-4">
          <h3 className="font-display font-bold text-white mb-4 flex items-center gap-2">
            <Server className="w-5 h-5 text-neon-blue" />
            Targeted Ports/Services
          </h3>
          {summaryLoading ? (
            <div className="h-64 flex items-center justify-center">
              <LoadingSpinner />
            </div>
          ) : (
            <div className="h-64">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={summary?.top_ports?.slice(0, 8) || []} layout="vertical">
                  <XAxis type="number" stroke="#555" tick={{ fill: '#888', fontSize: 11 }} />
                  <YAxis
                    type="category"
                    dataKey="service"
                    stroke="#555"
                    tick={{ fill: '#888', fontSize: 11 }}
                    width={80}
                  />
                  <Tooltip
                    contentStyle={{
                      backgroundColor: 'rgba(26, 26, 37, 0.95)',
                      border: '1px solid rgba(255,255,255,0.1)',
                      borderRadius: '8px',
                    }}
                    formatter={(value: number, _name: string, props: any) => [
                      value.toLocaleString(),
                      `Port ${props.payload.port}`
                    ]}
                  />
                  <Bar dataKey="count" radius={[0, 4, 4, 0]}>
                    {(summary?.top_ports?.slice(0, 8) || []).map((item: any, i: number) => (
                      <Cell key={i} fill={PORT_COLORS[item.port] || '#888'} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
          )}
        </div>
      </div>

      {/* Port Table */}
      <div className="bg-bg-card rounded-xl border border-bg-hover p-4">
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-display font-bold text-white">Port/Service Details</h3>
          <ExportToolbar
            onExportCSV={() => exportToCSV(summary?.top_ports || [], 'malware_ports')}
          />
        </div>
        <DataTable
          columns={portColumns}
          data={summary?.top_ports || []}
          loading={summaryLoading}
          maxHeight="300px"
        />
      </div>

      {/* Info Box */}
      <div className="bg-bg-card rounded-xl border border-neon-orange/30 p-4">
        <h3 className="font-display font-bold text-neon-orange mb-2 flex items-center gap-2">
          <Bug className="w-5 h-5" />
          About Dionaea Data
        </h3>
        <p className="text-sm text-text-secondary">
          Dionaea is a low-interaction honeypot that emulates vulnerable services to capture malware.
          This page shows connection attempts to these emulated services. The honeypot captures
          exploit attempts without actually becoming infected, providing safe visibility into
          attacker techniques targeting common vulnerable services.
        </p>
      </div>
    </div>
  );
}

